import { Logger, ValidationPipe } from '@nestjs/common';
import { NestFactory } from '@nestjs/core';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app/app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  const globalPrefix = 'api';
  app.setGlobalPrefix(globalPrefix);

  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
      transformOptions: {
        enableImplicitConversion: true,
      },
    }),
  );

  app.enableCors({
    origin: process.env.CORS_ORIGIN || '*',
    credentials: true,
  });

  const config = new DocumentBuilder()
    .setTitle('DKN API')
    .setDescription('Digital Knowledge Network API for Velion Dynamics')
    .setVersion('1.0')
    .addBearerAuth()
    .addTag('auth', 'Authentication endpoints')
    .addTag('users', 'User management endpoints')
    .addTag('offices', 'Office management endpoints')
    .addTag('ideas', 'Idea submission and crowdsourcing endpoints')
    .addTag('reviews', 'Idea review endpoints')
    .addTag('projects', 'Innovation project management endpoints')
    .addTag('rewards', 'Recognition and rewards endpoints')
    .addTag('audit', 'Audit log endpoints')
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  const port = process.env.PORT || 3000;
  await app.listen(port);
  Logger.log(`ðŸš€ Application is running on: http://localhost:${port}/${globalPrefix}`);
  Logger.log(`ðŸ“š Swagger docs available at: http://localhost:${port}/api/docs`);
}

bootstrap();
